# 斐波那契金字塔建仓量化交易系统

## 📊 项目简介

这是一个基于斐波那契回调理论和金字塔建仓策略的量化交易系统。系统自动分析股票最近的涨停行情，计算斐波那契回调位，并生成智能分批建仓订单。

### 核心策略

1. **查找涨停时间**：使用 baostock 查找股票最近60天内的涨停日期
2. **计算高低点**：提取涨停后的最高价和最低价
3. **斐波那契回调**：计算 0.382, 0.5, 0.618, 0.7, 0.786 等关键回调位
4. **金字塔建仓**：
   - **第一阶段**：0.5-0.618回调区间，分5次进入，占总仓位70% (每次14%)
   - **第二阶段**：0.618-0.7回调区间��分3次进入,占总仓位30% (每次10%)

### 特点

- ✅ 自动化分析涨停股票回调位
- ✅ 科学的斐波那契回调计算
- ✅ 金字塔式分批建仓，风险可控
- ✅ 简洁美观的Web界面
- ✅ 支持XTTrader接口下单
- ✅ 完整的订单预览和执行

---

## 🏗️ 项目结构

```
snapback/
├── backend/                 # 后端代码
│   ├── app.py              # Flask API服务
│   ├── strategy.py         # 策略核心逻辑
│   └── xt_trader.py        # XTTrader交易接口
├── frontend/               # 前端代码
│   └── index.html          # Web界面
├── requirements.txt        # Python依赖
└── README.md              # 项目文档
```

---

## 🚀 快速开始

### 1. 环境要求

- Python 3.8+
- pip

### 2. 安装依赖

```bash
cd /home/ubuntu/dev/snapback
pip install -r requirements.txt
```

### 3. 启动服务

```bash
cd backend
python app.py
```

服务将在 `http://localhost:5000` 启动

### 4. 访问界面

在浏览器中打开：
```
http://localhost:5000
```

---

## 📖 使用指南

### 步骤1：输入参数

1. **股票代码**：输入股票代码，支持格式：
   - `600000` (自动识别为 sh.600000)
   - `sh.600000` (上海股票)
   - `000001` (自动识别为 sz.000001)
   - `sz.000001` (深圳股票)
   - `300xxx` (创业板)

2. **总投资金额**：输入计划投资的总金额（单位：元）
   - 建议至少 10,000 元以上
   - 金额会按照 7:3 的比例分配到两个阶段

### 步骤2：分析并生成订单

点击 **"🔍 分析并生成订单"** 按钮，系统将：

1. 查询该股票最近60天的涨停记录
2. 找到涨停后的最高价和最低价
3. 计算斐波那契回调位
4. 生成8笔分批建仓订单

### 步骤3：查看分析结果

系统会显示：

- **订单摘要**：总订单数、各阶段订单数、总金额
- **涨停信息**：涨停日期、最高价、最低价、当前价
- **斐波那契回调位**：各个关键价位
- **订单明细表**：每笔订单的价格、金额、占比

### 步骤4：执行订单（可选）

确认订单无误后，点击 **"✅ 执行订单"** 按钮：

- 系统会通过 XTTrader 接口批量下单
- 显示执行结果（成功/失败数量）

> ⚠️ **注意**：当前版本使用模拟模式，不会真实下单。如需真实交易，请配置 XTTrader 账户。

---

## 🔧 API 接口文档

### 1. 分析股票

**请求**
```http
POST /api/analyze
Content-Type: application/json

{
  "stock_code": "sh.600000",
  "total_amount": 100000
}
```

**响应**
```json
{
  "success": true,
  "data": {
    "stock_code": "sh.600000",
    "total_amount": 100000,
    "limit_up_info": {
      "limit_up_date": "2025-10-15",
      "limit_up_price": 12.50,
      "highest_price": 13.80,
      "lowest_price": 11.20,
      "current_price": 12.00
    },
    "fibonacci_levels": {
      "0.382": 12.81,
      "0.500": 12.50,
      "0.618": 12.19,
      "0.700": 11.98,
      "0.786": 11.76
    },
    "orders": [
      {
        "stage": 1,
        "order_no": 1,
        "price": 12.50,
        "amount": 14000,
        "percentage": 14.0,
        "description": "第一阶段第1单 (0.5-0.618回调区间)"
      },
      ...
    ],
    "summary": {
      "total_orders": 8,
      "stage1_orders": 5,
      "stage1_amount": 70000,
      "stage2_orders": 3,
      "stage2_amount": 30000
    }
  }
}
```

### 2. 执行订单

**请求**
```http
POST /api/execute
Content-Type: application/json

{
  "stock_code": "sh.600000",
  "orders": [
    {"price": 12.50, "amount": 14000},
    ...
  ],
  "account_id": "",
  "account_key": ""
}
```

**响应**
```json
{
  "success": true,
  "data": {
    "total": 8,
    "success": 8,
    "failed": 0,
    "results": [
      {
        "order": {...},
        "success": true,
        "order_id": "MOCK_sh.600000_12.50_1000",
        "volume": 1000,
        "message": "模拟订单已提交"
      },
      ...
    ]
  }
}
```

### 3. 健康检查

**请求**
```http
GET /api/health
```

**响应**
```json
{
  "status": "ok",
  "service": "Fibonacci Pyramid Trading System"
}
```

---

## 📊 策略详解

### 斐波那契回调理论

斐波那契回调是技术分析中常用的工具，基于斐波那契数列的比率：

- **0.382** (38.2%)
- **0.500** (50.0%)
- **0.618** (61.8%) - 黄金分割点
- **0.700** (70.0%)
- **0.786** (78.6%)

当股票从高点回调时，这些比率往往成为重要的支撑位。

### 金字塔建仓策略

**原理**：价格越低，买入越多，形成金字塔形态的仓位分布。

**本系统实现**：

```
第一阶段 (0.5-0.618回调) - 70%仓位
├── 订单1: 14% @ 0.500回调位
├── 订单2: 14% @ 0.530回调位
├── 订单3: 14% @ 0.559回调位
├── 订单4: 14% @ 0.588回调位
└── 订单5: 14% @ 0.618回调位

第二阶段 (0.618-0.7回调) - 30%仓位
├── 订单6: 10% @ 0.618回调位
├── 订单7: 10% @ 0.659回调位
└── 订单8: 10% @ 0.700回调位
```

**优势**：
- ✅ 分散风险，避免一次性买在高位
- ✅ 利用回调机会，降低平均成本
- ✅ 自动化执行，消除情绪影响

---

## ⚙️ 配置说明

### XTTrader 配置

如需真实交易，需要修改 `backend/xt_trader.py`：

```python
class XTTraderClient:
    def __init__(self, account_id: str = "", account_key: str = ""):
        # 配置您的 XTTrader 账户
        self.account_id = account_id
        self.account_key = account_key
```

### Baostock 配置

系统自动使用 baostock 获取数据，无需额外配置。

- 查询范围：最近60天
- 数据频率：日线
- 复权方式：不复权

---

## 🧪 测试

### 单元测试

测试策略模块：

```bash
cd backend
python strategy.py
```

测试交易模块：

```bash
cd backend
python xt_trader.py
```

### 示例输出

```
订单生成成功:
股票代码: sh.600000
总金额: 100000.0

涨停信息:
  涨停日期: 2025-10-15
  最高价: 13.80
  最低价: 11.20
  当前价: 12.00

斐波那契回调位:
  0.382: 12.81
  0.500: 12.50
  0.618: 12.19
  0.700: 11.98
  0.786: 11.76

订单明细:
  第一阶段第1单 (0.5-0.618回调区间): 价格 12.50, 金额 14000.0
  第一阶段第2单 (0.5-0.618回调区间): 价格 12.42, 金额 14000.0
  ...
```

---

## 🔒 风险提示

⚠️ **重要声明**

1. **本系统仅供学习研究使用**，不构成任何投资建议
2. **股市有风险，投资需谨慎**，请根据自身风险承受能力决策
3. **历史数据不代表未来表现**，策略回测不保证实盘收益
4. **请在充分理解策略原理后使用**，建议先小额测试
5. **真实交易前请仔细检查订单**，避免操作失误

### 策略局限性

- ❌ 无法预测未来走势
- ❌ 不保证回调一定会到达目标位
- ❌ 市场可能跌破所有回调位
- ❌ 涨停后可能继续上涨不回调
- ❌ 需要足够的��金分批建仓

---

## 🛠️ 技术栈

### 后端
- **Flask** - Web框架
- **baostock** - 股票数据获取
- **pandas** - 数据处理
- **numpy** - 数值计算

### 前端
- **HTML5/CSS3** - 界面
- **JavaScript** - 交互逻辑
- **Fetch API** - HTTP请求

### 交易接口
- **XTTrader** - 股票交易接口

---

## 📝 开发计划

- [ ] 支持更多回调区间配置
- [ ] 添加止损止盈设置
- [ ] 支持多股票同时分析
- [ ] 添加历史订单记录
- [ ] 实现策略回测功能
- [ ] 支持实时监控价格触发
- [ ] 添加微信/邮件通知

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

## 📄 许可证

MIT License

---

## 👨‍💻 作者

Created with ❤️ using Claude Code

---

## 📞 联系方式

如有问题或建议，请通过以下方式联系：

- 提交 Issue
- 发送邮件

---

## 🙏 致谢

- [baostock](http://baostock.com/) - 提供免费的股票数据
- [Flask](https://flask.palletsprojects.com/) - 优秀的Python Web框架
- [XTTrader](https://dict.thinktrader.net/) - 提供股票交易接口

---

**Happy Trading! 📈**
